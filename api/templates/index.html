<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ShortyAPI – URL Shortener</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #333;
    }
    .container {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 20px;
      color: #222;
    }
    .hidden { display: none; }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #007BFF;
      box-shadow: 0 0 4px rgba(0,123,255,0.3);
    }
    button {
      background: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    .btn-choice {
      display: flex;
      gap: 10px;
    }
    .btn-choice button { flex: 1; }
    .status {
      font-size: 0.9rem;
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .links-list {
      margin-top: 15px;
      padding: 0;
      list-style: none;
    }
    .link-item {
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    .link-item a {
      color: #007BFF;
      text-decoration: none;
      word-break: break-all;
    }
    .link-item a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ShortyAPI</h1>

  <!-- Choice Screen -->
  <div id="choiceScreen">
    <div class="btn-choice">
      <button onclick="showForm('register')">Register</button>
      <button onclick="showForm('login')">Login</button>
    </div>
  </div>

  <!-- Register Form -->
  <div id="registerScreen" class="hidden">
    <h3>Register</h3>
    <input id="regUser" placeholder="Username">
    <input id="regPass" type="password" placeholder="Password">
    <button onclick="registerUser()">Sign Up</button>
    <p id="registerStatus" class="status hidden"></p>
    <button onclick="goBack()">⬅ Back</button>
  </div>

  <!-- Login Form -->
  <div id="loginScreen" class="hidden">
    <h3>Login</h3>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="loginUser()">Sign In</button>
    <p id="loginStatus" class="status hidden"></p>
    <button onclick="goBack()">⬅ Back</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden">
    <h3>URL Shortener</h3>
    <input id="longUrl" placeholder="https://example.com">
    <button onclick="shortenUrl()">Shorten</button>
    <p id="shortResult" class="status hidden"></p>

    <h3>My Links</h3>
    <button onclick="getMyLinks()">Refresh Links</button>
    <ul id="myLinks" class="links-list"></ul>
  </div>
</div>

<script>
let accessToken = null;

function showForm(type) {
  document.getElementById('choiceScreen').classList.add('hidden');
  document.getElementById('registerScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById(type + 'Screen').classList.remove('hidden');
}

function goBack() {
  document.getElementById('choiceScreen').classList.remove('hidden');
  document.getElementById('registerScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.add('hidden');
}

function showDashboard() {
  document.getElementById('choiceScreen').classList.add('hidden');
  document.getElementById('registerScreen').classList.add('hidden');
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
}

function showStatus(id, message, type) {
  const el = document.getElementById(id);
  el.innerText = message;
  el.className = `status ${type}`;
  el.classList.remove('hidden');
}

function registerUser() {
  fetch('/register/', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      username: document.getElementById('regUser').value.trim(),
      password: document.getElementById('regPass').value.trim()
    })
  }).then(res => res.json()).then(data => {
    if (data.username) {
      showStatus('registerStatus', "✅ Registered successfully!", "success");
    } else {
      showStatus('registerStatus', "❌ Registration failed.", "error");
    }
  }).catch(() => {
    showStatus('registerStatus', "⚠ Error connecting to server.", "error");
  });
}

function loginUser() {
  fetch('/token/', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      username: document.getElementById('loginUser').value.trim(),
      password: document.getElementById('loginPass').value.trim()
    })
  }).then(res => res.json()).then(data => {
    if (data.access) {
      accessToken = data.access;
      showStatus('loginStatus', "✅ Logged in!", "success");
      setTimeout(showDashboard, 500);
    } else {
      showStatus('loginStatus', "❌ Login failed.", "error");
    }
  }).catch(() => {
    showStatus('loginStatus', "⚠ Error connecting to server.", "error");
  });
}

function shortenUrl() {
  if (!accessToken) return alert('Please login first');
  fetch('/shorten/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + accessToken
    },
    body: JSON.stringify({
      original_url: document.getElementById('longUrl').value.trim()
    })
  }).then(res => res.json()).then(data => {
    if (data.short_code) {
      const link = `${location.origin}/${data.short_code}`;
      showStatus('shortResult', `Short URL: ${link}`, "success");
      document.getElementById('shortResult').innerHTML = `<a href="${link}" target="_blank">${link}</a>`;
    } else {
      showStatus('shortResult', "❌ Failed to shorten URL.", "error");
    }
  });
}
function deleteLink(code) {
  if (!confirm("Are you sure you want to delete this link?")) return;
  fetch(`/delete/${code}/`, {
    method: 'DELETE',
    headers: { 'Authorization': 'Bearer ' + accessToken }
  }).then(res => res.json()).then(data => {
    alert(data.message || "Deleted");
    getMyLinks(); // refresh list
  }).catch(() => {
    alert("Error deleting link.");
  });
}


function getMyLinks() {
  if (!accessToken) return alert('Please login first');
  fetch('/my-links/', {
    headers: { 'Authorization': 'Bearer ' + accessToken }
  }).then(res => res.json()).then(data => {
    const list = document.getElementById('myLinks');
    list.innerHTML = '';
    if (data.length === 0) {
      list.innerHTML = `<li class="link-item">No links found.</li>`;
      return;
    }
    data.forEach(link => {
      const li = document.createElement('li');
      li.className = "link-item";
li.innerHTML = `
  <a href="/${link.short_code}" target="_blank">${location.origin}/${link.short_code}</a> → ${link.original_url} 
  <br><small>Clicks: ${link.clicks}</small> 
  <button style="margin-left:10px; color:red;" onclick="deleteLink('${link.short_code}')">🗑 Delete</button>
`;
      list.appendChild(li);
    });
  });
}
</script>
</body>
</html>
